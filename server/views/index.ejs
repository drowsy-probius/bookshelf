<!DOCTYPE html>
<html>
  <head>
    <% include ./common/head %>
  </head>
  <body>
    <style>
      @media (min-width: 1200px){
        .col-xl-2 {
            -ms-flex: 0 0 20%;
            flex: 0 0 20%;
            max-width: 20%;
        }
      }

      .cover{
        height: 200px;
        overflow: hidden;
        position: relative;
      }

      .preview-img {
        width: 100%;
        display: inline-block;
        background-color: lightgray;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;
      }

      .preview-txt {
        width: 100%;
        display: inline-block;
        text-indent: 25px;
        background-color: lightgray;
        font: -webkit-control;
        white-space: break-spaces;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .book {
        display: flex;
        flex-direction: column;
      }

      .date {
        font-size: 70%!important;
      }

      html, body, main {
        height: 100%;
      }
    </style>

    <main>
      <% include ./common/header %>

      <div class="album py-5 bg-light">
        <div class="container">
          <div class="row" id="books">
          </div>
        </div>

        <div class="footer-pagination">
          <ul class="pagination justify-content-center align-items-end">
            <li class="page-item">
              <a class="page-link" href="#" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
                <span class="sr-only">Previous</span>
              </a>
            </li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item">
              <a class="page-link" href="#" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
                <span class="sr-only">Next</span>
              </a>
            </li>
          </ul>
        </div>

      </div>


      <script>
        const socket = io('/index', {forceNew: true});
        let __books = [];
        let __request = null;
        let __pagesize = 20;
        let __offset = 0;
        let __hasNext = false;
        let __index_entry_work = null;

        function __check_index_work_done(){
          if( __books.length >= __pagesize )
          {
            clearInterval(__index_entry_work);
            __index_entry_work = null;
          }
        }

        window.onload = function(){
          __index_entry_work = setInterval(function(){
            console.log("index job works.");
          }, 1000)
        }

        socket.emit('index', {pagesize:__pagesize, offset:__offset});
        
        socket.on('book', raw => {
          const book = raw.book;
          __hasNext = raw.hasNext;
          
          if(__books.includes(book._id)) return;
          __books.push(book._id);
          // console.debug('new book: ' + book.path);
          // console.debug(hasNext);

          let preview = book.type === 'txt' ? 
          `<div class="preview-txt reader" data-holder-rendered="true" data-id="${book._id}">${book.preview}</div>` :
          `<img class="preview-img reader" data-holder-rendered="true" src="${buf2img(book.preview)}" data-id="${book._id}">`;

          let entry = createElement('div', 'col-sm-6 col-md-4 col-lg-3 col-xl-2 book')
          entry.innerHTML = `
                  <div class="card mb-4 shadow-sm">
                    <div class="cover"> ${preview} </div> 
                    <div class="card-body">
                      <p class="card-text reader" data-id="${book._id}">${book.title.title} - ${book.title.episode}</p>
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group" style="left: -0.5em;">
                          <svg class="download" data-id="${book._id}" width="1.4em" height="1.5em" viewBox="0 0 16 16" class="bi bi-download" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <title>download</title>
                            <path fill-rule="evenodd" d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path fill-rule="evenodd" d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                          </svg>  
                        </div>
                        <small class="text-muted date" name="added">${new Date(book.added).toLocaleString('ko-KR')}</small>
                      </div>
                    </div>
                  </div>  `;
          
          
          document.getElementById('books').appendChild(entry);

          socket.emit('received', {book: book._id});
        });
        

        $(document).ready(function(){
          /**
           * 화살표 함수로 쓰면 this의 범위가 전체 document로 바뀜
           * 그러면 data-id를 불러올 수 없음.
           */
          $("body").on('click', '.reader', function(event){
            event.preventDefault();
            const id = $(this).data('id');
            const win = window.open(`/reader/${id}`, '_blank');
            win.focus();
            console.log(`open reader ${id}`);
          });
          
          $('body').on('click', '.download', function(event){
            event.preventDefault();
            const id = $(this).data('id');
            const win = window.open(`/reader/${id}/download`, '_blank');
            win.focus();
            console.debug(`donwload ${id}`);
          });
        });

        window.onscroll = function(){
          if( __books.length >= __pagesize && ($(window).innerHeight() + $(window).scrollTop()) >= $("body").height() && __hasNext )
          {
            __offset += __pagesize;
            socket.emit('index', {pagesize:__pagesize, offset:__offset});
          }
        }
      </script>

    </main>
    <% include ./common/footer %>
  </body>
</html>
